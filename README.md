# POC with Flask and Alembic

This Proof of Concept (POC) demonstrates the creation and execution of migrations with Alembic.
It includes both conventional migrations and manually written SQL scripts to address scenarios where migrations are not executed via the application.
Flask is used to validate the created structure, although its use is optional and not integral to the core purpose.

## Key Objectives

- Validate Alembic migrations executed via scripts at application startup.
- Demonstrate the use of manually created SQL scripts for migrations.
- Verify API initialization behavior after migration execution using Flask.

---

## üìÅ Project Structure

```plaintext
.
‚îú‚îÄ‚îÄ alembic                                        # Alembic migration management
‚îÇ   ‚îú‚îÄ‚îÄ env.py
‚îÇ   ‚îú‚îÄ‚îÄ README
‚îÇ   ‚îú‚îÄ‚îÄ script.py.mako
‚îÇ   ‚îú‚îÄ‚îÄ sql                                        # Directory for manual SQL migration scripts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ create_comments_table.sql
‚îÇ   ‚îî‚îÄ‚îÄ versions                                   # Directory for autogenerated Alembic migrations
‚îÇ       ‚îú‚îÄ‚îÄ  3a3ecd6b4d29_create_posts_table.py
|       ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ alembic.ini
‚îú‚îÄ‚îÄ docker-compose.yml
‚îú‚îÄ‚îÄ Dockerfile
‚îú‚îÄ‚îÄ Makefile
‚îú‚îÄ‚îÄ poetry.lock
‚îú‚îÄ‚îÄ pyproject.toml
‚îú‚îÄ‚îÄ README.md
‚îî‚îÄ‚îÄ src                                            # Application source code
    ‚îú‚îÄ‚îÄ app.py
    ‚îú‚îÄ‚îÄ models                                     # SQLAlchemy models
    ‚îÇ   ‚îú‚îÄ‚îÄ base.py
    |   ‚îî‚îÄ‚îÄ ...
    ‚îî‚îÄ‚îÄ routes                                     # API route definitions
        ‚îú‚îÄ‚îÄ dto
        ‚îÇ   ‚îú‚îÄ‚îÄ create_post_response.py
        |   ‚îî‚îÄ‚îÄ ...
        ‚îú‚îÄ‚îÄ posts.py
        ‚îî‚îÄ‚îÄ users.py
```

---

## üöÄ Getting Started

### Requirements

- Python (>=3.8)
- Poetry
- Docker and Docker Compose

### Installation and Setup

1. Clone the repository:

   ```bash
   git clone git@github.com:pedrodalvy/poc-flask-alembic.git
   cd poc-flask-alembic
   ```

2. Install dependencies with Poetry:

   ```bash
   poetry install
   ```

3. Start the application using Docker Compose:

   ```bash
   make up
   ```

4. Access the application:

    - API: [http://localhost:5000](http://localhost:5000)
    - Alembic migrations are automatically executed at startup.

5. To stop the application:

   ```bash
   make down
   ```

---

## üîç Example Usage

### Create a New Alembic Revision

```bash
make revision name="add_example_table"
```

### Apply Migrations

```bash
make migrate
```

### View Migration History

```bash
make history
```

### Downgrade a Specific Revision

```bash
make downgrade revision="<revision-id>"
```

| Command          | Description                                 |
|------------------|---------------------------------------------|
| `make up`        | Start the application using Docker Compose. |
| `make down`      | Stop the application and remove containers. |
| `make logs`      | View application logs.                      |
| `make revision`  | Create a new Alembic migration revision.    |
| `make migrate`   | Apply the latest migrations.                |
| `make history`   | View migration history.                     |
| `make downgrade` | Downgrade to a specific Alembic revision.   |

---

## üõ†Ô∏è Additional Notes

- **Manual SQL Scripts**: Place manually written SQL migration scripts in the `alembic/sql` directory and integrate them into the migration process.
- **Task Automation**: The `Makefile` simplifies common tasks like starting, stopping, and managing migrations.
- **Extensibility**: Although Flask is used here, the structure is generic enough to support other frameworks or standalone Python scripts.

---

Feel free to modify and adapt this POC for more complex use cases or additional frameworks.
